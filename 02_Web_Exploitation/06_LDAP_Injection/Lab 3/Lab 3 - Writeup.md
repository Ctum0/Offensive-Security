# Lab 3: Attribute Discovery & Filter Hijacking

---
## TARGET

**Self-Hosted Lab** (Docker/Python/OpenLDAP) **Objective:** Discover hidden service accounts and exfiltrate "Secret Keys" from non-standard attributes.

---
## DESCRIPTION
The application utilizes a restrictive LDAP search filter that enforces an `objectClass=person` check to limit user access. However, the application fails to sanitize input, allowing for **Logical Filter Injection**. An attacker can "break out" of the intended filter scope to query the entire directory, including non-person objects like Service Accounts.

---
## INFRASTRUCTURE BUILD
**Vulnerable Code Snippet (`app.py`):**
```python
# The filter forces 'objectClass=person', limiting the search scope.
search_filter = f"(&(objectClass=person)(cn={user})(userPassword={pw}))"
```
**Deployment:** The directory includes a hidden service account (`svc_backup`) containing a sensitive flag in its `description` attribute, mimicking a hardcoded API key or system secret.

---
## ROOT CAUSE
**Logical Filter Injection (CWE-90):** The application does not validate the balance of parentheses in user input. An attacker can inject a closing parenthesis `)` to terminate the developer's intended filter (`objectClass` check) and append a new, arbitrary filter (`cn=*`) that the LDAP server executes independently.

---
## ATTACK SCENARIO
1. **Reconnaissance:** The attacker attempts standard injection but finds the results limited to known users (`admin`).
2. **Filter Hijacking:** The attacker injects `*)(cn=s*`. This transforms the query into: `(&(objectClass=person)(cn=*)(cn=s*)(userPassword=*))`
    - _Logic:_ The server processes the first closed group `(cn=*)`, effectively ignoring the `objectClass` restriction.    
3. **Discovery:** By fuzzing the starting character, the attacker discovers `svc_backup`.
4. **Exfiltration:** Using the newly discovered username, the attacker performs a **Blind Boolean Injection** to dump the `description` attribute character-by-character.

---
## PROOF OF CONCEPT
### Discovery Phase
- **Payload:** `*)(cn=s*`
- **Result:** `SUCCESS: svc_backup`
### Exfiltration Phase
- **Payload:** `svc_backup)(description=SYSTEM_K*`
- **Result:** `SUCCESS` (Boolean True)
- **Extracted Data:** `SYSTEM_KEY{LDAP_PIVOT_SUCCESS}`
    
---
## IMPACT
**Critical:** Complete exposure of the directory structure and sensitive attributes (credentials, keys, notes) belonging to privileged service accounts, enabling further lateral movement.

---
## FIX / MITIGATION
1. **Escaping:** Implement strict escaping of special characters (`(`, `)`, `*`, `\`, `NUL`) using `ldap3.utils.conv.escape_filter_chars`.
2. **Validation:** Enforce an allowlist for usernames (e.g., alphanumeric only).