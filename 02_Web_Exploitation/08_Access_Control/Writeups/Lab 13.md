# Referer-based access control
---
## TARGET
PortSwigger Web Security Academy  
Lab: _Referer-based access control_
Vulnerability: _Broken Access Control (Insecure Trust in HTTP Headers)_

---
## DESCRIPTION
The application restricts access to the administrative role-change functionality (`/admin-roles`) by verifying the HTTP `Referer` header. It allows the request only if the `Referer` header indicates that the request originated from the `/admin` page. This control is flawed because the `Referer` header is client-controlled and can be easily spoofed by an attacker.

---
## ROOT CAUSE
**Client-Side Trust:** The server relies on the HTTP `Referer` header to authorize sensitive actions. Since this header is generated by the user's browser (client-side) and can be manipulated by tools like Burp Suite or custom scripts, it cannot serve as a trusted security control.

---
## ATTACK SCENARIO
1. **Reconnaissance:** The attacker logs in as a standard user (`wiener`) and attempts to access the admin panel or upgrade functionality.
2. **Analysis:** The attacker intercepts the traffic and identifies that requests to `/admin-roles` fail unless the `Referer` header is set to the admin dashboard URL.
3. **Exploitation:** The attacker constructs a request to upgrade their user to an administrator, manually injecting the header `Referer: https://<LAB-ID>.web-security-academy.net/admin`.
4. **Bypass:** The server validates the header, accepts the request, and promotes the attacker to an administrator.

---
## PROOF OF CONCEPT
**Vulnerable Request:**
```HTTP
GET /admin-roles?username=wiener&action=upgrade HTTP/1.1
Host: <LAB-ID>.web-security-academy.net
Cookie: session=WIENER_SESSION_TOKEN
Referer: https://<LAB-ID>.web-security-academy.net/admin
```

---
## IMPACT
**Critical:** Unauthorized Privilege Escalation. An attacker can bypass the access control check to perform administrative actions, such as user promotion or deletion.

---
## FIX / MITIGATION
1. **Server-Side Authorization:** Remove reliance on the `Referer` header for security decisions. Implement proper session-based access control lists (ACLs) on the server.
2. **Anti-CSRF Tokens:** While `Referer` checking is sometimes used as a weak CSRF defense, robust anti-CSRF tokens should be used instead.

---
## KEY LEARNING
**Headers are User Input.** HTTP headers like `Referer`, `User-Agent`, and `X-Forwarded-For` are entirely under the control of the client. Never use them as the sole mechanism for authentication or authorization.

---
